<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
    <title>–ú–µ–Ω—é –∫–∞—Ñ–µ</title>
</head>
<body>
    <div class="container">
        <div class="inner">
            <div class="item" id="shawarma-item">
                <img src="shawarma.jpg" alt="–®–∞—É—Ä–º–∞" class="img">
                <h3>–®–∞—É—Ä–º–∞</h3>
                <p class="price" id="shawarma-price">25k —Ä—É–ø–∏–π.</p>
                <div class="filling-buttons">
                    <button class="filling-btn" data-filling="chicken" data-emoji="üêì">üêì</button>
                    <button class="filling-btn" data-filling="beef" data-emoji="üêÆ">üêÆ</button>
                    <button class="filling-btn" data-filling="shrimp" data-emoji="ü¶ê">ü¶ê</button>
                    <button class="filling-btn" data-filling="falafel" data-emoji="üå±">üå±</button>
                </div>
                <button class="btn" id="btn-shawarma">–î–æ–±–∞–≤–∏—Ç—å</button>
            </div>
            <!-- –û—Å—Ç–∞–ª—å–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã –º–µ–Ω—é –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π -->
        </div>
    </div>
    
    <div class="usercard" id="usercard"></div>
    
    <button id="voiceOrderBtn" aria-label="–ì–æ–ª–æ—Å–æ–≤–æ–π –∑–∞–∫–∞–∑">üé§</button>
    
    <!-- –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ –ø–æ–º–æ—â–Ω–∏–∫–∞ -->
    <div id="voiceInterface" class="voice-interface">
        <div id="chat" class="chat"></div>
        <div class="input-area">
            <input type="text" id="textInput" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...">
            <button id="sendTextBtn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
            <button id="recordVoiceBtn">–ó–∞–ø–∏—Å—å</button>
            <div id="recordingStatus"></div>
        </div>
    </div>

    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="config.js"></script>
    <script src="app1.js"></script>
    
    <!-- –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∞—É–¥–∏–æ -->
    <script>
    let mediaRecorder;
    let audioChunks = [];

    function checkAudioSupport() {
        const types = [
            'audio/webm;codecs=opus',
            'audio/wav',
            'audio/ogg;codecs=opus'
        ];
        
        types.forEach(type => {
            console.log(`${type} –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è: ${MediaRecorder.isTypeSupported(type)}`);
        });
    }

    async function startRecording() {
        const audioConstraints = {
            audio: {
                channelCount: 1,
                sampleRate: 16000,
                sampleSize: 16,
                echoCancellation: true,
                noiseSuppression: true,
                autoGainControl: true
            }
        };

        try {
            const stream = await navigator.mediaDevices.getUserMedia(audioConstraints);
            mediaRecorder = new MediaRecorder(stream);

            mediaRecorder.ondataavailable = event => {
                audioChunks.push(event.data);
            };

            mediaRecorder.onstop = async () => {
                const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                sendAudioToServer(audioBlob);
            };

            mediaRecorder.start();
            document.getElementById('recordingStatus').textContent = '–ó–∞–ø–∏—Å—å...';
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É', error);
            document.getElementById('recordingStatus').textContent = '–û—à–∏–±–∫–∞: ' + error.message;
        }
    }

    function stopRecording() {
        if (mediaRecorder && mediaRecorder.state !== 'inactive') {
            mediaRecorder.stop();
            document.getElementById('recordingStatus').textContent = '–ó–∞–ø–∏—Å—å –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞. –û–±—Ä–∞–±–æ—Ç–∫–∞...';
        }
    }

    function sendAudioToServer(audioBlob) {
        const formData = new FormData();
        formData.append('audio', audioBlob, 'recording.webm');

        fetch('/upload-audio', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            console.log('–£—Å–ø–µ—Ö:', data);
            document.getElementById('recordingStatus').textContent = '–ê—É–¥–∏–æ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!';
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞:', error);
            document.getElementById('recordingStatus').textContent = '–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∞—É–¥–∏–æ: ' + error.message;
        });
    }

    document.getElementById('recordVoiceBtn').addEventListener('mousedown', startRecording);
    document.getElementById('recordVoiceBtn').addEventListener('mouseup', stopRecording);
    document.getElementById('recordVoiceBtn').addEventListener('mouseleave', stopRecording);

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É —Ñ–æ—Ä–º–∞—Ç–æ–≤ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    checkAudioSupport();
    </script>
</body>
</html>
